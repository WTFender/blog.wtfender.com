name: Setup AWS

on:
  workflow_dispatch:
  push:
    paths:
      - 'pulumi/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@master
  
    - name: Download Artifact
      id: download-artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: deploy.yml
        workflow_conclusion: success
        branch: main
        name: public.tar.gz
        if_no_artifact_found: fail

    - name: Extract Archive
      run: tar -xzvf public.tar.gz

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 16

    - name: Install Dependencies
      run: cd pulumi && npm install

    - name: Deploy Infra
      uses: pulumi/actions@v3
      with:
        command: up
        stack-name: ${{ secrets.PULUMI_STACK_NAME }}
        work-dir: ./pulumi
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}